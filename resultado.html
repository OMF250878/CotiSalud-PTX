<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resultados de Cotizaci√≥n ‚Äî Protexa</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilos adicionales para el bot√≥n de env√≠o de email */
    .btn--email {
      background-color: #007bff;
      color: white;
      margin-left: 10px;
    }
    
    .btn--email:hover {
      background-color: #0056b3;
    }
    
    .btn--email:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .email-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .email-status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .email-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .email-status.loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .retry-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .retry-btn:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <header class="site-header site-header--compact">
    <img src="protexa-logo.png" alt="Protexa" class="brand__logo--sm" />
  </header>

  <main class="results-container">
    <!-- META del contratante -->
    <section id="quoteMeta" class="quote-meta" aria-label="Datos del contratante"></section>

    <div class="results-actions">
      <button class="btn btn--back" onclick="history.back()">Volver</button>
      <button class="btn btn--print" onclick="window.print()">Imprimir</button>
      <button id="emailBtn" class="btn btn--email" onclick="sendEmail()">Enviar email</button>
    </div>

    <!-- Status del env√≠o de email -->
    <div id="emailStatus" class="email-status" style="display: none;"></div>

    <div id="results" class="results-grid" aria-live="polite"></div>

    <!-- Disclaimer -->
    <section class="disclaimer">
      <h3>Importante</h3>
      <ul>
        <li><strong>Validez de la cotizaci√≥n:</strong> Esta cotizaci√≥n tiene una vigencia de 7 d√≠as. No obstante, la aseguradora puede modificar su tarifario durante este per√≠odo, lo que requerir√° una actualizaci√≥n de la propuesta.</li>
        <li><strong>Valores mensuales:</strong> Los montos mensuales son aproximados y se basan en un financiamiento de 12 cuotas sin intereses, exclusivo para pagos mediante d√©bito autom√°tico (obligatorio). La aseguradora podr√≠a aplicar intereses o cambiar su pol√≠tica de financiamiento.</li>
        <li><strong>Edad cotizada:</strong> La edad considerada en la cotizaci√≥n debe coincidir con la edad al momento de presentar la solicitud.</li>
        <li><strong>Ex√°menes m√©dicos:</strong> La aseguradora puede requerir ex√°menes m√©dicos si lo considera necesario.</li>
      </ul>
    </section>
  </main>

  <script>
    let emailRetryCount = 0;
    const MAX_RETRIES = 3;
    const WEBHOOK_URL = 'https://primary-production-e1c81.up.railway.app/webhook/8690a13d-7871-4513-90af-22c2db337394';

    (function () {
      const RAW = sessionStorage.getItem('cotisalud_resultados');
      const resultsEl = document.getElementById('results');
      const metaEl = document.getElementById('quoteMeta');

      if (!RAW) {
        resultsEl.innerHTML = '<p>No se encontraron resultados. Vuelve al formulario y realiza una cotizaci√≥n.</p>';
        return;
      }

      // Soporta formato {meta, data} y tambi√©n el legado [array]
      let parsed = JSON.parse(RAW);
      let meta = null;
      let results = [];
      if (Array.isArray(parsed)) {
        results = parsed;
      } else {
        meta = parsed.meta || null;
        results = parsed.data || [];
      }

      // Render META si existe
      function formatDDMMYYYY(iso) {
        const d = iso ? new Date(iso) : new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      if (meta) {
        metaEl.innerHTML = `
          <div class="meta-grid">
            <div><span class="meta-label">Contratante:</span> ${meta.nombre} ${meta.apellidos}</div>
            <div><span class="meta-label">Correo:</span> ${meta.email}</div>
            <div><span class="meta-label">Fecha de cotizaci√≥n:</span> ${formatDDMMYYYY(meta.fecha)}</div>
            <div><span class="meta-label">Broker:</span> ${meta.broker || 'Protexa Corredores de Seguros SAC'}</div>
          </div>
        `;
      } else {
        metaEl.remove();
      }

      /** @type {Array<{aseguradora:string,plan:string,total_anual:number,total_mensual:number,prima_por_asegurado:Array<{edad:number,prima:number}>}>} */

      // 1) Agrupar por aseguradora
      const grupos = results.reduce((acc, item) => {
        (acc[item.aseguradora] ||= []).push(item);
        return acc;
      }, {});

      // 2) Ordenar por total_anual (desc)
      const SORT_KEY = 'total_anual';
      const fmtMoney = (n) => (typeof n === 'number' ? n : Number(n))
        .toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      // 3) Render
      resultsEl.innerHTML = '';
      Object.entries(grupos).forEach(([aseguradora, planes]) => {
        planes.sort((a, b) => (b[SORT_KEY] ?? 0) - (a[SORT_KEY] ?? 0));

        const col = document.createElement('section');
        col.className = 'insurer-col';
        col.innerHTML = `<h2>${aseguradora}</h2>`;

        planes.forEach(p => {
          const card = document.createElement('article');
          card.className = 'plan-card';
          card.innerHTML = `
            <h3>${p.plan}</h3>
            <div class="badges">
              <span class="badge">S/ ${fmtMoney(p.total_mensual)} / mes</span>
              <span class="badge badge--accent">S/ ${fmtMoney(p.total_anual)} / a√±o</span>
            </div>
            <div>
              <strong>Primas por asegurado</strong>
              <ul class="prima-list">
                ${Array.isArray(p.prima_por_asegurado)
                  ? p.prima_por_asegurado.map(r => `<li>Edad ${r.edad}: S/ ${fmtMoney(r.prima)}</li>`).join('')
                  : '<li>-</li>'}
              </ul>
            </div>
          `;
          col.appendChild(card);
        });

        resultsEl.appendChild(col);
      });

      // Hacer disponible los datos para la funci√≥n de env√≠o de email
      window.quotationData = { meta, results };
    })();

    // Funci√≥n para preparar el JSON seg√∫n el formato requerido
    function prepareEmailData() {
      const { meta, results } = window.quotationData;
      
      if (!meta) {
        throw new Error('No se encontraron los datos del contratante');
      }

      // Formatear fecha
      function formatSpanishDate(iso) {
        const months = [
          'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
          'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
        ];
        const d = iso ? new Date(iso) : new Date();
        const day = d.getDate();
        const month = months[d.getMonth()];
        const year = d.getFullYear();
        return `${day} de ${month} de ${year}`;
      }

      return {
        client_name: meta.nombre || '',
        client_lastname: meta.apellidos || '',
        client_email: meta.email || '',
        lista_asegurados: results || [],
        quote_date: formatSpanishDate(meta.fecha)
      };
    }

    // Funci√≥n para mostrar el estado del env√≠o
    function showEmailStatus(message, type, showRetry = false) {
      const statusEl = document.getElementById('emailStatus');
      statusEl.style.display = 'block';
      statusEl.className = `email-status ${type}`;
      
      let content = message;
      if (showRetry && emailRetryCount < MAX_RETRIES) {
        content += `<button class="retry-btn" onclick="sendEmail()">Reintentar (${emailRetryCount}/${MAX_RETRIES})</button>`;
      }
      
      statusEl.innerHTML = content;
    }

    // Funci√≥n principal para enviar el email
    async function sendEmail() {
      const emailBtn = document.getElementById('emailBtn');
      
      try {
        // Preparar datos
        const emailData = prepareEmailData();
        
        // Mostrar estado de carga
        emailBtn.disabled = true;
        emailBtn.textContent = 'Enviando...';
        showEmailStatus('üìß Enviando cotizaci√≥n por email...', 'loading');

        // Realizar petici√≥n al webhook
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailData)
        });

        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
        }

        // √âxito
        emailRetryCount = 0;
        emailBtn.disabled = true; // Mantener deshabilitado despu√©s del √©xito
        emailBtn.textContent = '‚úì Email enviado';
        showEmailStatus('‚úÖ ¬°Cotizaci√≥n enviada por email exitosamente!', 'success');

      } catch (error) {
        console.error('Error enviando email:', error);
        emailRetryCount++;
        
        // Restaurar bot√≥n
        emailBtn.disabled = false;
        emailBtn.textContent = 'Enviar email';
        
        if (emailRetryCount < MAX_RETRIES) {
          showEmailStatus(
            `‚ùå Error al enviar email: ${error.message}. Intento ${emailRetryCount}/${MAX_RETRIES}.`,
            'error',
            true
          );
        } else {
          showEmailStatus(
            '‚ùå Error al enviar email despu√©s de varios intentos. Por favor, contacta a soporte t√©cnico.',
            'error'
          );
        }
      }
    }
  </script>
</body>
</html>

